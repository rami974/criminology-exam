<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام امتحان علم الجريمة - Firebase Edition</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.2em;
        }

        .firebase-status {
            background: #e8f5e8;
            border: 2px solid #4caf50;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
            color: #2e7d32;
        }

        .nav-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            padding: 15px 30px;
            margin: 0 10px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            transition: all 0.3s ease;
            color: #2c3e50;
        }

        .nav-btn.active {
            background: #3498db;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .page {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            min-height: 500px;
        }

        .page.active {
            display: block;
        }

        .exam-form {
            max-width: 600px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2c3e50;
            font-size: 1.1em;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.3);
        }

        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            transition: all 0.3s ease;
            width: 100%;
        }

        .btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .status-message {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: bold;
            text-align: center;
            display: none;
        }

        .status-message.success {
            background: #d4edda;
            border: 2px solid #27ae60;
            color: #155724;
        }

        .status-message.error {
            background: #f8d7da;
            border: 2px solid #e74c3c;
            color: #721c24;
        }

        .exam-interface {
            display: none;
        }

        .exam-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 5px solid #3498db;
        }

        .exam-info {
            display: flex;
            gap: 30px;
        }

        .exam-info span {
            font-weight: bold;
            color: #2c3e50;
        }

        .timer {
            font-size: 1.5em;
            font-weight: bold;
            color: #e74c3c;
            background: white;
            padding: 10px 20px;
            border-radius: 10px;
            border: 2px solid #e74c3c;
        }

        .question-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-right: 5px solid #3498db;
        }

        .question-card.hard {
            border-right-color: #e74c3c;
            background: #fef9f9;
        }

        .question-number {
            font-size: 1.2em;
            font-weight: bold;
            color: #7f8c8d;
            margin-bottom: 10px;
        }

        .question-text {
            font-size: 1.3em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 20px;
            line-height: 1.8;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .option {
            display: flex;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .option:hover {
            background: #e3f2fd;
            transform: translateX(5px);
        }

        .option.selected {
            background: #e3f2fd;
            border-color: #3498db;
            box-shadow: 0 3px 10px rgba(52, 152, 219, 0.3);
        }

        .option input {
            margin-left: 15px;
            transform: scale(1.3);
        }

        .option label {
            font-size: 1.1em;
            cursor: pointer;
            flex: 1;
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }

        .nav-btn-exam {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .nav-btn-exam:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .nav-btn-exam:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }

        .submit-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.2em;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .submit-btn:hover {
            background: #219a52;
            transform: translateY(-2px);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #ecf0f1;
            border-radius: 10px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            width: 0%;
            transition: width 0.3s ease;
        }

        .trainer-login {
            max-width: 400px;
            margin: 0 auto;
            text-align: center;
        }

        .trainer-dashboard {
            display: none;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-top: 4px solid #3498db;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #7f8c8d;
            font-size: 1.1em;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .results-table th,
        .results-table td {
            padding: 15px;
            text-align: center;
            border-bottom: 1px solid #eee;
        }

        .results-table th {
            background: #3498db;
            color: white;
            font-weight: bold;
        }

        .results-table tr:hover {
            background: #f8f9fa;
        }

        .loading-spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .connection-status {
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
            display: inline-block;
            margin-bottom: 10px;
        }

        .connection-status.online {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .connection-status.offline {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .connection-status.syncing {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .instructions {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-right: 4px solid #3498db;
        }

        .instructions h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .instructions ul {
            color: #555;
            padding-right: 20px;
        }

        .instructions li {
            margin-bottom: 8px;
        }

        .admin-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .admin-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .admin-btn:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }

        .admin-btn.warning {
            background: #f39c12;
        }

        .admin-btn.warning:hover {
            background: #d68910;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2em;
            }

            .exam-info {
                flex-direction: column;
                gap: 15px;
            }

            .timer {
                font-size: 1.2em;
            }

            .question-card {
                padding: 20px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .admin-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div id="connectionStatus" class="connection-status offline">🔴 Firebase غير متصل</div>
            <h1>🔥 نظام امتحان علم الجريمة - Firebase Edition</h1>
            <p>نظام متقدم مع قاعدة بيانات مشتركة في الوقت الفعلي</p>
            <div class="firebase-status">
                <span id="firebaseStatusText">جاري الاتصال بـ Firebase...</span>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-btn active" onclick="showPage('student')">صفحة الطلاب</button>
            <button class="nav-btn" onclick="showPage('trainer')">صفحة المدرب</button>
        </div>

        <!-- صفحة الطلاب -->
        <div id="studentPage" class="page active">
            <div class="instructions">
                <h3>تعليمات الامتحان:</h3>
                <ul>
                    <li>النظام يستخدم Firebase لقاعدة بيانات مشتركة</li>
                    <li>الامتحان يحتوي على 20 سؤال اختيار من متعدد</li>
                    <li>15 سؤال عادي (65 نقطة) + 5 أسئلة صعبة (35 نقطة)</li>
                    <li>مدة الامتحان 45 دقيقة</li>
                    <li>يمكنك التنقل بين الأسئلة والعودة لتعديل إجاباتك</li>
                    <li>الأسئلة الصعبة مميزة باللون الأحمر</li>
                    <li>تأكد من الإجابة على جميع الأسئلة قبل التسليم</li>
                    <li>بعد التسليم لا يمكن إعادة الامتحان بنفس الاسم</li>
                    <li>كل نموذج يمكن استخدامه لطالب واحد فقط</li>
                </ul>
            </div>

            <div id="studentStatusMessage" class="status-message"></div>

            <div class="exam-form">
                <h2 style="text-align: center; margin-bottom: 30px; color: #2c3e50;">معلومات الطالب</h2>
                
                <div class="form-group">
                    <label for="studentName">اسم الطالب:</label>
                    <input type="text" id="studentName" placeholder="أدخل اسمك الثلاثي كاملاً" required>
                </div>

                <div class="form-group">
                    <label for="examModel">نموذج الامتحان:</label>
                    <select id="examModel" required>
                        <option value="">اختر نموذج الامتحان</option>
                    </select>
                </div>

                <button id="startExam" class="btn">
                    <div id="loadingSpinner" class="loading-spinner"></div>
                    🚀 بدء الامتحان
                </button>
            </div>

            <!-- واجهة الامتحان -->
            <div id="examInterface" class="exam-interface">
                <div class="exam-header">
                    <div class="exam-info">
                        <span>الطالب: <span id="studentNameDisplay"></span></span>
                        <span>النموذج: <span id="modelDisplay"></span></span>
                        <span>السؤال: <span id="questionCounter"></span></span>
                    </div>
                    <div id="timer" class="timer">45:00</div>
                </div>

                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill"></div>
                </div>

                <div id="questionContainer" class="question-card">
                    <!-- سيتم تحميل الأسئلة هنا -->
                </div>

                <div class="navigation">
                    <button id="prevBtn" class="nav-btn-exam" onclick="navigateQuestion(-1)">السؤال السابق</button>
                    <button id="nextBtn" class="nav-btn-exam" onclick="navigateQuestion(1)">السؤال التالي</button>
                    <button id="submitBtn" class="submit-btn" onclick="submitExam()">تسليم الامتحان</button>
                </div>
            </div>
        </div>

        <!-- صفحة المدرب -->
        <div id="trainerPage" class="page">
            <div class="trainer-login">
                <h2 style="margin-bottom: 30px; color: #2c3e50;">تسجيل دخول المدرب</h2>
                <div id="trainerStatusMessage" class="status-message"></div>
                
                <div class="form-group">
                    <label for="trainerPassword">كلمة المرور:</label>
                    <input type="password" id="trainerPassword" placeholder="أدخل كلمة مرور المدرب">
                </div>
                
                <button id="loginBtn" class="btn" onclick="loginTrainer()">تسجيل الدخول</button>
            </div>

            <div id="trainerDashboard" class="trainer-dashboard">
                <h2 style="margin-bottom: 30px; color: #2c3e50;">لوحة التحكم</h2>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div id="totalExams" class="stat-value">0</div>
                        <div class="stat-label">إجمالي الامتحانات</div>
                    </div>
                    <div class="stat-card">
                        <div id="activeExams" class="stat-value">0</div>
                        <div class="stat-label">امتحانات نشطة</div>
                    </div>
                    <div class="stat-card">
                        <div id="completedExams" class="stat-value">0</div>
                        <div class="stat-label">امتحانات مكتملة</div>
                    </div>
                    <div class="stat-card">
                        <div id="averageScore" class="stat-value">0%</div>
                        <div class="stat-label">متوسط الدرجات</div>
                    </div>
                </div>

                <div class="admin-actions">
                    <button class="admin-btn warning" onclick="resetUsedNamesAdmin()">إعادة تعيين الأسماء المستخدمة</button>
                    <button class="admin-btn warning" onclick="resetUsedModelsAdmin()">إعادة تعيين النماذج المحجوزة</button>
                    <button class="admin-btn" onclick="clearAllDataAdmin()">مسح جميع البيانات</button>
                    <button class="admin-btn" onclick="exportResults()">تصدير النتائج</button>
                </div>

                <h3 style="margin: 30px 0 20px 0; color: #2c3e50;">الامتحانات النشطة:</h3>
                <div id="activeExamsContainer">
                    <table id="activeExamsTable" class="results-table">
                        <thead>
                            <tr>
                                <th>اسم الطالب</th>
                                <th>النموذج</th>
                                <th>وقت البدء</th>
                                <th>الوقت المنقضي</th>
                                <th>الحالة</th>
                            </tr>
                        </thead>
                        <tbody id="activeExamsBody">
                        </tbody>
                    </table>
                </div>

                <h3 style="margin: 30px 0 20px 0; color: #2c3e50;">نتائج الامتحانات:</h3>
                <div id="resultsContainer">
                    <table id="resultsTable" class="results-table">
                        <thead>
                            <tr>
                                <th>اسم الطالب</th>
                                <th>النموذج</th>
                                <th>الدرجة</th>
                                <th>النسبة المئوية</th>
                                <th>وقت الإكمال</th>
                                <th>مدة الامتحان</th>
                            </tr>
                        </thead>
                        <tbody id="resultsBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        // إعدادات Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyA7qOMk2DeUscXXyR6QaAbITKwF-X1yDhY",
            authDomain: "criminology-exam.firebaseapp.com",
            projectId: "criminology-exam",
            storageBucket: "criminology-exam.firebasestorage.app",
            messagingSenderId: "583774841680",
            appId: "1:583774841680:web:455a3de88036b62ed41a55"
        };

        // متغيرات Firebase
        let firebaseApp = null;
        let firestore = null;
        let isFirebaseInitialized = false;

        // إعدادات النظام
        const EXAM_DURATION = 45 * 60;
        const TRAINER_PASSWORD = "trainer123";

        // بنك الأسئلة
        const questionBank = [
            {
                id: 1,
                difficulty: 'normal',
                points: 3,
                question: "من هو مؤسس المدرسة الأنثروبولوجية في علم الجريمة؟",
                options: [
                    "إنريكو فيري",
                    "رافائيل جاروفالو", 
                    "تشيزاري لومبروزو",
                    "إميل دوركايم"
                ],
                correct: 2
            },
            {
                id: 2,
                difficulty: 'normal',
                points: 4,
                question: "ما هو التعريف الأساسي لعلم الجريمة؟",
                options: [
                    "دراسة القوانين الجنائية فقط",
                    "العلم الذي يدرس الجريمة والمجرم والمجتمع",
                    "دراسة طرق التحقيق الجنائي",
                    "تطبيق العقوبات على المجرمين"
                ],
                correct: 1
            },
            {
                id: 3,
                difficulty: 'normal',
                points: 4,
                question: "أي من التالي يُعتبر من أهداف علم الجريمة؟",
                options: [
                    "زيادة معدلات الجريمة",
                    "فهم أسباب الجريمة ووضع استراتيجيات الوقاية",
                    "تبرير سلوك المجرمين",
                    "تعقيد النظام القضائي"
                ],
                correct: 1
            },
            {
                id: 4,
                difficulty: 'normal',
                points: 4,
                question: "ما هو المقصود بـ'المدرسة الكلاسيكية' في علم الجريمة؟",
                options: [
                    "مدرسة تركز على العوامل البيولوجية للجريمة",
                    "مدرسة تؤكد على حرية الإرادة والمسؤولية الفردية",
                    "مدرسة تدرس الجرائم الحديثة فقط",
                    "مدرسة تهتم بالعوامل الاجتماعية حصراً"
                ],
                correct: 1
            },
            {
                id: 5,
                difficulty: 'normal',
                points: 4,
                question: "وفقاً للمدرسة الوضعية، ما هو السبب الرئيسي للجريمة؟",
                options: [
                    "حرية الاختيار الفردي",
                    "العوامل البيولوجية والنفسية والاجتماعية",
                    "ضعف القوانين",
                    "عدم وجود عقوبات رادعة"
                ],
                correct: 1
            },
            {
                id: 6,
                difficulty: 'normal',
                points: 4,
                question: "ما هي خصائص المجرم الفطري حسب نظرية لومبروزو؟",
                options: [
                    "ذكاء عالي ومظهر عادي",
                    "سمات جسدية بدائية وانحراف خلقي",
                    "تعليم عالي وثقافة واسعة",
                    "عدم وجود خصائص مميزة"
                ],
                correct: 1
            },
            {
                id: 7,
                difficulty: 'normal',
                points: 4,
                question: "ما هي المشكلة المنهجية الرئيسية في دراسة الجريمة المعروفة بـ'الأرقام المظلمة'؟",
                options: [
                    "صعوبة قراءة الإحصائيات",
                    "الجرائم غير المسجلة في الإحصائيات الرسمية",
                    "عدم وضوح أرقام الجرائم",
                    "تضارب في البيانات الإحصائية"
                ],
                correct: 1
            },
            {
                id: 8,
                difficulty: 'normal',
                points: 4,
                question: "أي من التالي يُعتبر من مبادئ الأخلاقيات في البحث الجنائي؟",
                options: [
                    "كشف هوية المشاركين في البحث",
                    "إجبار المشاركين على التعاون",
                    "الموافقة المستنيرة وحماية الخصوصية",
                    "نشر جميع المعلومات دون قيود"
                ],
                correct: 2
            },
            {
                id: 9,
                difficulty: 'normal',
                points: 4,
                question: "ما هو التعريف الأساسي لعلم الجريمة الرقمي؟",
                options: [
                    "دراسة الجرائم التقليدية فقط",
                    "دراسة الجرائم المرتكبة في البيئة الرقمية",
                    "استخدام الحاسوب في التحقيق",
                    "تطبيق القوانين الرقمية"
                ],
                correct: 1
            },
            {
                id: 10,
                difficulty: 'normal',
                points: 5,
                question: "أي من التالي يُعتبر من أنواع الجرائم البيئية؟",
                options: [
                    "السرقة والنصب فقط",
                    "التلوث غير القانوني وتدمير الموائل الطبيعية",
                    "الجرائم الجنسية فقط",
                    "جرائم المخدرات فقط"
                ],
                correct: 1
            },
            {
                id: 11,
                difficulty: 'normal',
                points: 5,
                question: "ما هو الهدف من النظريات التكاملية في علم الجريمة؟",
                options: [
                    "إلغاء النظريات السابقة",
                    "دمج النظريات المختلفة لفهم أشمل للجريمة",
                    "تعقيد دراسة الجريمة",
                    "التركيز على نظرية واحدة فقط"
                ],
                correct: 1
            },
            {
                id: 12,
                difficulty: 'normal',
                points: 5,
                question: "ما هو دور الخبرة الجنائية في المحاكمات؟",
                options: [
                    "تعقيد الإجراءات القضائية",
                    "تقديم رأي علمي موضوعي لمساعدة المحكمة",
                    "تبرئة المتهمين دائماً",
                    "إدانة المتهمين دائماً"
                ],
                correct: 1
            },
            {
                id: 13,
                difficulty: 'normal',
                points: 5,
                question: "أي من التالي يُعتبر من تطبيقات علم الجريمة في السياسة الجنائية؟",
                options: [
                    "تطوير استراتيجيات الوقاية من الجريمة",
                    "زيادة العقوبات فقط",
                    "تجاهل البحوث العلمية",
                    "الاعتماد على الحدس فقط"
                ],
                correct: 0
            },
            {
                id: 14,
                difficulty: 'normal',
                points: 5,
                question: "ما هي العلاقة بين علم الجريمة والقانون الجنائي؟",
                options: [
                    "لا توجد علاقة بينهما",
                    "علاقة تكاملية حيث يوفر علم الجريمة الأسس العلمية للقانون",
                    "علاقة تنافسية",
                    "علم الجريمة يلغي الحاجة للقانون"
                ],
                correct: 1
            },
            {
                id: 15,
                difficulty: 'normal',
                points: 5,
                question: "أي من التالي يُعتبر من مجالات علم الجريمة الثقافي؟",
                options: [
                    "دراسة الموسيقى والفنون فقط",
                    "دراسة العلاقة بين الثقافة والسلوك الإجرامي",
                    "دراسة اللغات المختلفة",
                    "دراسة التاريخ القديم"
                ],
                correct: 1
            },
            {
                id: 16,
                difficulty: 'hard',
                points: 7,
                question: "وفقاً لنظرية الإشباع الإجرامي التي طورها إنريكو فيري، أي من التفسيرات التالية الأكثر دقة لهذا المفهوم؟",
                options: [
                    "كل مجتمع يحتوي على قدر ثابت من الجريمة لا يمكن تغييره",
                    "كل مجتمع يحتوي على قدر محدد من الجريمة يتحدد بتفاعل العوامل الأنثروبولوجية والفيزيقية والاجتماعية",
                    "المجتمعات الحديثة تحتوي على جرائم أكثر من المجتمعات التقليدية",
                    "الجريمة تزداد بزيادة عدد السكان فقط"
                ],
                correct: 1
            },
            {
                id: 17,
                difficulty: 'hard',
                points: 7,
                question: "في سياق النماذج التفسيرية الشاملة للجريمة، ما هو المقصود بـ'التكامل التفاعلي' بين العوامل المختلفة؟",
                options: [
                    "جمع العوامل المختلفة دون تحليل العلاقات بينها",
                    "دراسة كيفية تأثير العوامل على بعضها البعض في نظام ديناميكي معقد",
                    "التركيز على عامل واحد فقط في كل مرة",
                    "ترتيب العوامل حسب الأهمية"
                ],
                correct: 1
            },
            {
                id: 18,
                difficulty: 'hard',
                points: 7,
                question: "بناءً على مفهوم 'الانتقاء الطبيعي الاجتماعي' الذي طرحه جاروفالو، أي من التطبيقات التالية يعكس هذا المفهوم بدقة؟",
                options: [
                    "إعادة تأهيل جميع المجرمين دون استثناء",
                    "إزالة العناصر غير المتكيفة اجتماعياً من المجتمع لحماية تطوره",
                    "تطبيق نفس العقوبة على جميع المجرمين",
                    "التركيز على العوامل الاقتصادية فقط"
                ],
                correct: 1
            },
            {
                id: 19,
                difficulty: 'hard',
                points: 7,
                question: "في إطار النظريات متعددة الأبعاد، ما هو التحدي الأساسي في إثبات العلاقات السببية في دراسة الجريمة؟",
                options: [
                    "عدم توفر البيانات الكافية",
                    "تعقد السلوك الإنساني وتداخل العوامل المؤثرة مما يجعل عزل تأثير عامل واحد شبه مستحيل",
                    "قلة الباحثين المتخصصين",
                    "عدم وجود تقنيات قياس مناسبة"
                ],
                correct: 1
            },
            {
                id: 20,
                difficulty: 'hard',
                points: 7,
                question: "وفقاً للاتجاهات الحديثة في علم الجريمة، كيف يؤثر مفهوم 'النسبية الثقافية' على دراسة الجرائم الثقافية والممارسات التقليدية الضارة؟",
                options: [
                    "يبرر جميع الممارسات الثقافية دون استثناء",
                    "يلغي الحاجة لحقوق الإنسان العالمية",
                    "يخلق توتراً بين احترام التنوع الثقافي وحماية حقوق الإنسان العالمية",
                    "يجعل دراسة الجريمة مستحيلة"
                ],
                correct: 2
            }
        ];

        // نماذج الامتحان
        const examModels = {
            'A': [1, 6, 11, 16, 2, 7, 12, 17, 3, 8, 13, 18, 4, 9, 14, 19, 5, 10, 15, 20],
            'B': [5, 10, 15, 20, 1, 6, 11, 16, 2, 7, 12, 17, 3, 8, 13, 18, 4, 9, 14, 19],
            'C': [3, 8, 13, 18, 5, 10, 15, 20, 1, 6, 11, 16, 2, 7, 12, 17, 4, 9, 14, 19],
            'D': [4, 9, 14, 19, 3, 8, 13, 18, 5, 10, 15, 20, 1, 6, 11, 16, 2, 7, 12, 17],
            'E': [2, 7, 12, 17, 4, 9, 14, 19, 1, 6, 11, 16, 5, 10, 15, 20, 3, 8, 13, 18],
            'F': [6, 1, 16, 11, 7, 2, 17, 12, 8, 3, 18, 13, 9, 4, 19, 14, 10, 5, 20, 15],
            'G': [10, 5, 20, 15, 6, 1, 16, 11, 7, 2, 17, 12, 8, 3, 18, 13, 9, 4, 19, 14],
            'H': [8, 3, 18, 13, 10, 5, 20, 15, 6, 1, 16, 11, 7, 2, 17, 12, 9, 4, 19, 14],
            'I': [9, 4, 19, 14, 8, 3, 18, 13, 10, 5, 20, 15, 6, 1, 16, 11, 7, 2, 17, 12],
            'J': [7, 2, 17, 12, 9, 4, 19, 14, 8, 3, 18, 13, 10, 5, 20, 15, 6, 1, 16, 11]
        };

        // متغيرات النظام
        let currentStudent = null;
        let currentExam = null;
        let currentQuestionIndex = 0;
        let studentAnswers = {};
        let examTimer = null;
        let timeRemaining = EXAM_DURATION;
        let examStartTime = null;
        let isTrainerLoggedIn = false;

        // تهيئة النظام
        document.addEventListener('DOMContentLoaded', function() {
            try {
                initializeFirebase();
            } catch (error) {
                console.log('خطأ في Firebase، التبديل إلى LocalStorage:', error);
                setupLocalStorageFirebase();
            }
        });

        // تهيئة Firebase
        function initializeFirebase() {
            try {
                firebaseApp = firebase.initializeApp(firebaseConfig);
                firestore = firebase.firestore();
                isFirebaseInitialized = true;
                updateConnectionStatus('online');
                updateFirebaseStatus('متصل بـ Firebase بنجاح ✅');
                updateAvailableModels();
                console.log('🔥 Firebase تم تهيئته بنجاح');
            } catch (error) {
                console.error('خطأ في تهيئة Firebase:', error);
                updateConnectionStatus('offline');
                updateFirebaseStatus('فشل الاتصال: ' + error.message + ' ❌');
                setupLocalStorageFirebase();
            }
        }

        // إعداد LocalStorage كبديل
        function setupLocalStorageFirebase() {
            isFirebaseInitialized = false;
            updateConnectionStatus('offline');
            updateFirebaseStatus('يعمل في الوضع المحلي (LocalStorage) ⚠️');
            updateAvailableModels();
            console.log('🔄 تم التبديل إلى LocalStorage');
        }

        // وظائف Firebase
        async function checkNameAvailability(name) {
            if (!isFirebaseInitialized) {
                const normalizedName = name.toLowerCase().trim();
                const usedNames = JSON.parse(localStorage.getItem('usedNames') || '[]');
                const finishedStudents = JSON.parse(localStorage.getItem('finishedStudents') || '[]');
                return !usedNames.includes(normalizedName) && !finishedStudents.includes(normalizedName);
            }
            
            const normalizedName = name.toLowerCase().trim();
            try {
                const usedNamesDoc = await firestore.collection('system').doc('usedNames').get();
                const usedNames = usedNamesDoc.exists ? usedNamesDoc.data().names || [] : [];
                
                const finishedStudentsDoc = await firestore.collection('system').doc('finishedStudents').get();
                const finishedStudents = finishedStudentsDoc.exists ? finishedStudentsDoc.data().students || [] : [];
                
                return !usedNames.includes(normalizedName) && !finishedStudents.includes(normalizedName);
            } catch (error) {
                console.error('خطأ في فحص توفر الاسم:', error);
                throw error;
            }
        }

        async function checkModelAvailability(model) {
            if (!isFirebaseInitialized) {
                const usedModels = JSON.parse(localStorage.getItem('usedModels') || '{}');
                return !usedModels[model];
            }
            
            try {
                const usedModelsDoc = await firestore.collection('system').doc('usedModels').get();
                const usedModels = usedModelsDoc.exists ? usedModelsDoc.data().models || {} : {};
                return !usedModels[model];
            } catch (error) {
                console.error('خطأ في فحص توفر النموذج:', error);
                throw error;
            }
        }

        async function getAvailableModels() {
            if (!isFirebaseInitialized) {
                const usedModels = JSON.parse(localStorage.getItem('usedModels') || '{}');
                return Object.keys(examModels).filter(model => !usedModels[model]);
            }
            
            try {
                const usedModelsDoc = await firestore.collection('system').doc('usedModels').get();
                const usedModels = usedModelsDoc.exists ? usedModelsDoc.data().models || {} : {};
                return Object.keys(examModels).filter(model => !usedModels[model]);
            } catch (error) {
                console.error('خطأ في الحصول على النماذج المتاحة:', error);
                return Object.keys(examModels);
            }
        }

        async function reserveExam(studentName, model) {
            if (!isFirebaseInitialized) {
                const normalizedName = studentName.toLowerCase().trim();
                const examId = Date.now().toString();

                const usedNames = JSON.parse(localStorage.getItem('usedNames') || '[]');
                usedNames.push(normalizedName);
                localStorage.setItem('usedNames', JSON.stringify(usedNames));

                const usedModels = JSON.parse(localStorage.getItem('usedModels') || '{}');
                usedModels[model] = {
                    studentName: studentName,
                    reservedAt: new Date().toISOString(),
                    examId: examId
                };
                localStorage.setItem('usedModels', JSON.stringify(usedModels));

                const activeExams = JSON.parse(localStorage.getItem('activeExams') || '{}');
                activeExams[normalizedName] = {
                    studentName: studentName,
                    model: model,
                    examId: examId,
                    startTime: new Date().toISOString(),
                    status: 'active'
                };
                localStorage.setItem('activeExams', JSON.stringify(activeExams));

                return examId;
            }
            
            try {
                const batch = firestore.batch();
                const normalizedName = studentName.toLowerCase().trim();
                const examId = Date.now().toString();
                
                const usedNamesRef = firestore.collection('system').doc('usedNames');
                batch.set(usedNamesRef, {
                    names: firebase.firestore.FieldValue.arrayUnion(normalizedName)
                }, { merge: true });
                
                const usedModelsRef = firestore.collection('system').doc('usedModels');
                batch.set(usedModelsRef, {
                    models: {
                        [model]: {
                            studentName: studentName,
                            reservedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            examId: examId
                        }
                    }
                }, { merge: true });
                
                const activeExamRef = firestore.collection('activeExams').doc(normalizedName);
                batch.set(activeExamRef, {
                    studentName: studentName,
                    model: model,
                    examId: examId,
                    startTime: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'active'
                });
                
                await batch.commit();
                return examId;
            } catch (error) {
                console.error('خطأ في حجز الامتحان:', error);
                throw error;
            }
        }

        async function completeExam(studentName, examData) {
            if (!isFirebaseInitialized) {
                const normalizedName = studentName.toLowerCase().trim();

                const completedExams = JSON.parse(localStorage.getItem('completedExams') || '[]');
                completedExams.push({
                    ...examData,
                    completedAt: new Date().toISOString()
                });
                localStorage.setItem('completedExams', JSON.stringify(completedExams));

                const finishedStudents = JSON.parse(localStorage.getItem('finishedStudents') || '[]');
                finishedStudents.push(normalizedName);
                localStorage.setItem('finishedStudents', JSON.stringify(finishedStudents));

                const activeExams = JSON.parse(localStorage.getItem('activeExams') || '{}');
                delete activeExams[normalizedName];
                localStorage.setItem('activeExams', JSON.stringify(activeExams));
                return;
            }
            
            try {
                const batch = firestore.batch();
                const normalizedName = studentName.toLowerCase().trim();
                
                const completedExamRef = firestore.collection('completedExams').doc();
                batch.set(completedExamRef, {
                    ...examData,
                    completedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                const finishedStudentsRef = firestore.collection('system').doc('finishedStudents');
                batch.set(finishedStudentsRef, {
                    students: firebase.firestore.FieldValue.arrayUnion(normalizedName)
                }, { merge: true });
                
                const activeExamRef = firestore.collection('activeExams').doc(normalizedName);
                batch.delete(activeExamRef);
                
                await batch.commit();
            } catch (error) {
                console.error('خطأ في إكمال الامتحان:', error);
                throw error;
            }
        }

        // وظائف النظام
        function updateFirebaseStatus(message) {
            const statusText = document.getElementById('firebaseStatusText');
            if (statusText) {
                statusText.textContent = message;
            }
        }

        function updateConnectionStatus(status) {
            const statusElement = document.getElementById('connectionStatus');
            switch (status) {
                case 'online':
                    statusElement.textContent = '🟢 متصل بـ Firebase';
                    statusElement.className = 'connection-status online';
                    break;
                case 'offline':
                    statusElement.textContent = '🔴 وضع محلي';
                    statusElement.className = 'connection-status offline';
                    break;
                case 'syncing':
                    statusElement.textContent = '🟡 جاري المزامنة';
                    statusElement.className = 'connection-status syncing';
                    break;
            }
        }

        function showPage(pageType) {
            const navBtns = document.querySelectorAll('.nav-btn');
            const pages = document.querySelectorAll('.page');
            
            navBtns.forEach(btn => btn.classList.remove('active'));
            pages.forEach(page => page.classList.remove('active'));

            if (pageType === 'student') {
                document.getElementById('studentPage').classList.add('active');
                navBtns[0].classList.add('active');
                updateAvailableModels();
            } else if (pageType === 'trainer') {
                document.getElementById('trainerPage').classList.add('active');
                navBtns[1].classList.add('active');
                if (isTrainerLoggedIn) {
                    updateTrainerDashboard();
                }
            }
        }

        async function updateAvailableModels() {
            const modelSelect = document.getElementById('examModel');
            try {
                const availableModels = await getAvailableModels();
                modelSelect.innerHTML = '<option value="">اختر نموذج الامتحان</option>';
                
                availableModels.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model;
                    option.textContent = `نموذج ${model} - متاح`;
                    modelSelect.appendChild(option);
                });

                if (availableModels.length === 0) {
                    const option = document.createElement('option');
                    option.value = "";
                    option.textContent = "جميع النماذج محجوزة";
                    option.disabled = true;
                    modelSelect.appendChild(option);
                }
            } catch (error) {
                console.error('خطأ في تحديث النماذج:', error);
            }
        }

        function showMessage(message, type) {
            const messageDiv = document.getElementById('studentStatusMessage');
            messageDiv.textContent = message;
            messageDiv.className = `status-message ${type}`;
            messageDiv.style.display = 'block';
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 5000);
        }

        function showTrainerMessage(message, type) {
            const messageDiv = document.getElementById('trainerStatusMessage');
            messageDiv.textContent = message;
            messageDiv.className = `status-message ${type}`;
            messageDiv.style.display = 'block';
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 4000);
        }

        // بدء الامتحان
        document.getElementById('startExam').addEventListener('click', async function() {
            const studentName = document.getElementById('studentName').value.trim();
            const examModel = document.getElementById('examModel').value;
            const startButton = this;
            const loadingSpinner = document.getElementById('loadingSpinner');

            if (!studentName || !examModel) {
                showMessage('يرجى إدخال الاسم واختيار نموذج الامتحان', 'error');
                return;
            }

            if (studentName.length < 6) {
                showMessage('يجب أن يحتوي الاسم على 6 أحرف على الأقل', 'error');
                return;
            }

            startButton.disabled = true;
            loadingSpinner.style.display = 'inline-block';
            updateConnectionStatus('syncing');

            try {
                const nameAvailable = await checkNameAvailability(studentName);
                if (!nameAvailable) {
                    showMessage(`❌ الاسم "${studentName}" مستخدم بالفعل`, 'error');
                    return;
                }

                const modelAvailable = await checkModelAvailability(examModel);
                if (!modelAvailable) {
                    showMessage(`❌ النموذج "${examModel}" محجوز بالفعل`, 'error');
                    await updateAvailableModels();
                    return;
                }

                const examId = await reserveExam(studentName, examModel);
                currentStudent = {
                    name: studentName,
                    model: examModel,
                    examId: examId
                };

                initializeExam();
                showMessage('✅ تم بدء الامتحان بنجاح!', 'success');
                updateConnectionStatus(isFirebaseInitialized ? 'online' : 'offline');

                setTimeout(() => {
                    document.querySelector('.exam-form').style.display = 'none';
                    document.getElementById('examInterface').style.display = 'block';
                    startExamTimer();
                }, 2000);

            } catch (error) {
                console.error('خطأ في بدء الامتحان:', error);
                showMessage('❌ حدث خطأ في بدء الامتحان', 'error');
                updateConnectionStatus('offline');
            } finally {
                startButton.disabled = false;
                loadingSpinner.style.display = 'none';
            }
        });

        function initializeExam() {
            const questionOrder = examModels[currentStudent.model];
            currentExam = questionOrder.map(qId => questionBank.find(q => q.id === qId));
            currentQuestionIndex = 0;
            studentAnswers = {};
            timeRemaining = EXAM_DURATION;
            examStartTime = Date.now();

            document.getElementById('studentNameDisplay').textContent = currentStudent.name;
            document.getElementById('modelDisplay').textContent = currentStudent.model;
            
            displayQuestion();
            updateProgress();
        }

        function displayQuestion() {
            const question = currentExam[currentQuestionIndex];
            const container = document.getElementById('questionContainer');
            
            container.className = `question-card ${question.difficulty === 'hard' ? 'hard' : ''}`;
            
            container.innerHTML = `
                <div class="question-number">
                    السؤال ${currentQuestionIndex + 1} من ${currentExam.length} 
                    ${question.difficulty === 'hard' ? '(سؤال صعب - ' + question.points + ' نقاط)' : '(' + question.points + ' نقاط)'}
                </div>
                <div class="question-text">${question.question}</div>
                <div class="options">
                    ${question.options.map((option, index) => `
                        <div class="option ${studentAnswers[question.id] === index ? 'selected' : ''}" onclick="selectAnswer(${index})">
                            <input type="radio" name="question_${question.id}" value="${index}" ${studentAnswers[question.id] === index ? 'checked' : ''}>
                            <label>${option}</label>
                        </div>
                    `).join('')}
                </div>
            `;

            document.getElementById('questionCounter').textContent = `${currentQuestionIndex + 1} / ${currentExam.length}`;
            
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            document.getElementById('nextBtn').disabled = currentQuestionIndex === currentExam.length - 1;
        }

        function selectAnswer(optionIndex) {
            const question = currentExam[currentQuestionIndex];
            studentAnswers[question.id] = optionIndex;
            
            const options = document.querySelectorAll('.option');
            options.forEach((option, index) => {
                option.classList.toggle('selected', index === optionIndex);
                const radio = option.querySelector('input');
                radio.checked = index === optionIndex;
            });
            
            updateProgress();
        }

        function navigateQuestion(direction) {
            const newIndex = currentQuestionIndex + direction;
            if (newIndex >= 0 && newIndex < currentExam.length) {
                currentQuestionIndex = newIndex;
                displayQuestion();
            }
        }

        function updateProgress() {
            const answered = Object.keys(studentAnswers).length;
            const total = currentExam.length;
            const percentage = (answered / total) * 100;
            
            document.getElementById('progressFill').style.width = percentage + '%';
        }

        function startExamTimer() {
            examTimer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(examTimer);
                    submitExam(true);
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            const timerElement = document.getElementById('timer');
            
            timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            if (timeRemaining <= 300) {
                timerElement.style.color = '#e74c3c';
                timerElement.style.animation = 'pulse 1s infinite';
            } else if (timeRemaining <= 600) {
                timerElement.style.color = '#f39c12';
            }
        }

        async function submitExam(isAutoSubmit = false) {
            if (!isAutoSubmit) {
                const answered = Object.keys(studentAnswers).length;
                const total = currentExam.length;
                
                if (answered < total) {
                    const confirmSubmit = confirm(`لقد أجبت على ${answered} من ${total} أسئلة. هل تريد التسليم الآن؟`);
                    if (!confirmSubmit) {
                        return;
                    }
                }
            }

            clearInterval(examTimer);
            
            let score = 0;
            let correctAnswers = 0;
            
            currentExam.forEach(question => {
                if (studentAnswers[question.id] === question.correct) {
                    score += question.points;
                    correctAnswers++;
                }
            });

            const totalPoints = currentExam.reduce((sum, q) => sum + q.points, 0);
            const percentage = Math.round((score / totalPoints) * 100);
            const examDuration = Math.round((Date.now() - examStartTime) / 1000);

            const examData = {
                studentName: currentStudent.name,
                model: currentStudent.model,
                examId: currentStudent.examId,
                score: score,
                totalPoints: totalPoints,
                percentage: percentage,
                correctAnswers: correctAnswers,
                totalQuestions: currentExam.length,
                examDuration: examDuration,
                answers: studentAnswers,
                isAutoSubmit: isAutoSubmit
            };

            try {
                await completeExam(currentStudent.name, examData);
                displayResults(examData);
            } catch (error) {
                console.error('خطأ في تسليم الامتحان:', error);
                alert('حدث خطأ في تسليم الامتحان');
            }
        }

        function displayResults(examData) {
            const container = document.getElementById('examInterface');
            
            container.innerHTML = `
                <div style="text-align: center; padding: 40px; background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);">
                    <h2 style="color: #2c3e50; margin-bottom: 30px;">🎉 تم تسليم الامتحان بنجاح!</h2>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; border-right: 4px solid #3498db;">
                            <div style="font-size: 2em; font-weight: bold; color: #2c3e50;">${examData.score}</div>
                            <div style="color: #7f8c8d;">الدرجة من ${examData.totalPoints}</div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; border-right: 4px solid #27ae60;">
                            <div style="font-size: 2em; font-weight: bold; color: #2c3e50;">${examData.percentage}%</div>
                            <div style="color: #7f8c8d;">النسبة المئوية</div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; border-right: 4px solid #e74c3c;">
                            <div style="font-size: 2em; font-weight: bold; color: #2c3e50;">${examData.correctAnswers}</div>
                            <div style="color: #7f8c8d;">إجابات صحيحة من ${examData.totalQuestions}</div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; border-right: 4px solid #f39c12;">
                            <div style="font-size: 2em; font-weight: bold; color: #2c3e50;">${Math.floor(examData.examDuration / 60)}:${(examData.examDuration % 60).toString().padStart(2, '0')}</div>
                            <div style="color: #7f8c8d;">مدة الامتحان</div>
                        </div>
                    </div>
                    
                    <div style="background: ${examData.percentage >= 60 ? '#d4edda' : '#f8d7da'}; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h3 style="color: ${examData.percentage >= 60 ? '#155724' : '#721c24'}; margin-bottom: 10px;">
                            ${examData.percentage >= 60 ? '✅ مبروك! لقد نجحت في الامتحان' : '❌ للأسف، لم تحصل على درجة النجاح'}
                        </h3>
                        <p style="color: #666; margin: 0;">
                            ${examData.isAutoSubmit ? 'تم تسليم الامتحان تلقائياً بانتهاء الوقت' : 'تم تسليم الامتحان بنجاح'}
                        </p>
                    </div>
                    
                    <button onclick="location.reload()" style="background: #3498db; color: white; border: none; padding: 15px 30px; border-radius: 10px; cursor: pointer; font-size: 1.1em; font-weight: bold;">
                        العودة للصفحة الرئيسية
                    </button>
                </div>
            `;
        }

        // وظائف المدرب
        function loginTrainer() {
            const password = document.getElementById('trainerPassword').value;
            
            if (password === TRAINER_PASSWORD) {
                isTrainerLoggedIn = true;
                document.querySelector('.trainer-login').style.display = 'none';
                document.getElementById('trainerDashboard').style.display = 'block';
                updateTrainerDashboard();
                showTrainerMessage('✅ تم تسجيل الدخول بنجاح', 'success');
            } else {
                showTrainerMessage('❌ كلمة المرور غير صحيحة', 'error');
            }
        }

        async function getTrainerDashboardData() {
            if (!isFirebaseInitialized) {
                const activeExams = JSON.parse(localStorage.getItem('activeExams') || '{}');
                const completedExams = JSON.parse(localStorage.getItem('completedExams') || '[]');
                
                const activeExamsList = Object.values(activeExams).map(exam => ({
                    ...exam,
                    startTime: { toDate: () => new Date(exam.startTime) }
                }));
                
                const completedExamsList = completedExams.map(exam => ({
                    ...exam,
                    completedAt: { toDate: () => new Date(exam.completedAt) }
                }));
                
                const stats = {
                    total: activeExamsList.length + completedExamsList.length,
                    active: activeExamsList.length,
                    completed: completedExamsList.length,
                    average: completedExamsList.length > 0 ? 
                        Math.round(completedExamsList.reduce((sum, exam) => sum + exam.percentage, 0) / completedExamsList.length) : 0
                };
                
                return { activeExams: activeExamsList, completedExams: completedExamsList, stats };
            }
            
            try {
                const activeExamsSnapshot = await firestore.collection('activeExams').get();
                const activeExams = activeExamsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                const completedExamsSnapshot = await firestore.collection('completedExams')
                    .orderBy('completedAt', 'desc')
                    .get();
                const completedExams = completedExamsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                const stats = {
                    total: activeExams.length + completedExams.length,
                    active: activeExams.length,
                    completed: completedExams.length,
                    average: completedExams.length > 0 ? 
                        Math.round(completedExams.reduce((sum, exam) => sum + exam.percentage, 0) / completedExams.length) : 0
                };
                
                return { activeExams, completedExams, stats };
            } catch (error) {
                console.error('خطأ في الحصول على بيانات المدرب:', error);
                throw error;
            }
        }

        async function updateTrainerDashboard() {
            if (!isTrainerLoggedIn) return;
            
            try {
                const dashboardData = await getTrainerDashboardData();
                
                document.getElementById('totalExams').textContent = dashboardData.stats.total;
                document.getElementById('activeExams').textContent = dashboardData.stats.active;
                document.getElementById('completedExams').textContent = dashboardData.stats.completed;
                document.getElementById('averageScore').textContent = dashboardData.stats.average + '%';
                
                updateActiveExamsTable(dashboardData.activeExams);
                updateResultsTable(dashboardData.completedExams);
                
            } catch (error) {
                console.error('خطأ في تحديث لوحة المدرب:', error);
                showTrainerMessage('خطأ في تحديث البيانات', 'error');
            }
        }

        function updateActiveExamsTable(activeExams) {
            const tbody = document.getElementById('activeExamsBody');
            tbody.innerHTML = '';
            
            activeExams.forEach(exam => {
                const row = tbody.insertRow();
                const startTime = exam.startTime ? exam.startTime.toDate() : new Date();
                const elapsed = Math.floor((Date.now() - startTime.getTime()) / 1000);
                const elapsedMinutes = Math.floor(elapsed / 60);
                const elapsedSeconds = elapsed % 60;
                
                row.innerHTML = `
                    <td>${exam.studentName}</td>
                    <td>${exam.model}</td>
                    <td>${startTime.toLocaleString('ar-EG')}</td>
                    <td>${elapsedMinutes}:${elapsedSeconds.toString().padStart(2, '0')}</td>
                    <td><span style="color: #27ae60; font-weight: bold;">نشط</span></td>
                `;
            });
            
            if (activeExams.length === 0) {
                const row = tbody.insertRow();
                row.innerHTML = '<td colspan="5" style="text-align: center; color: #7f8c8d;">لا توجد امتحانات نشطة</td>';
            }
        }

        function updateResultsTable(completedExams) {
            const tbody = document.getElementById('resultsBody');
            tbody.innerHTML = '';
            
            completedExams.forEach(exam => {
                const row = tbody.insertRow();
                const completedTime = exam.completedAt ? exam.completedAt.toDate() : new Date();
                const durationMinutes = Math.floor(exam.examDuration / 60);
                const durationSeconds = exam.examDuration % 60;
                
                row.innerHTML = `
                    <td>${exam.studentName}</td>
                    <td>${exam.model}</td>
                    <td>${exam.score}/${exam.totalPoints}</td>
                    <td style="color: ${exam.percentage >= 60 ? '#27ae60' : '#e74c3c'}; font-weight: bold;">${exam.percentage}%</td>
                    <td>${completedTime.toLocaleString('ar-EG')}</td>
                    <td>${durationMinutes}:${durationSeconds.toString().padStart(2, '0')}</td>
                `;
            });
            
            if (completedExams.length === 0) {
                const row = tbody.insertRow();
                row.innerHTML = '<td colspan="6" style="text-align: center; color: #7f8c8d;">لا توجد نتائج</td>';
            }
        }

        // وظائف الإدارة
        async function resetUsedNames() {
            if (!isFirebaseInitialized) {
                localStorage.removeItem('usedNames');
                localStorage.removeItem('finishedStudents');
                return;
            }
            
            try {
                const batch = firestore.batch();
                const usedNamesRef = firestore.collection('system').doc('usedNames');
                batch.delete(usedNamesRef);
                const finishedStudentsRef = firestore.collection('system').doc('finishedStudents');
                batch.delete(finishedStudentsRef);
                await batch.commit();
            } catch (error) {
                throw error;
            }
        }

        async function resetUsedModels() {
            if (!isFirebaseInitialized) {
                localStorage.removeItem('usedModels');
                return;
            }
            
            try {
                const usedModelsRef = firestore.collection('system').doc('usedModels');
                await usedModelsRef.delete();
            } catch (error) {
                throw error;
            }
        }

        async function clearAllData() {
            if (!isFirebaseInitialized) {
                localStorage.clear();
                return;
            }
            
            try {
                const batch = firestore.batch();
                const collections = ['system', 'activeExams', 'completedExams'];
                
                for (const collectionName of collections) {
                    const snapshot = await firestore.collection(collectionName).get();
                    snapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                }
                
                await batch.commit();
            } catch (error) {
                throw error;
            }
        }

        async function resetUsedNamesAdmin() {
            if (confirm('هل أنت متأكد من إعادة تعيين جميع الأسماء المستخدمة؟')) {
                try {
                    await resetUsedNames();
                    showTrainerMessage('✅ تم إعادة تعيين الأسماء بنجاح', 'success');
                    updateTrainerDashboard();
                } catch (error) {
                    showTrainerMessage('❌ خطأ في إعادة تعيين الأسماء', 'error');
                }
            }
        }

        async function resetUsedModelsAdmin() {
            if (confirm('هل أنت متأكد من إعادة تعيين جميع النماذج المحجوزة؟')) {
                try {
                    await resetUsedModels();
                    showTrainerMessage('✅ تم إعادة تعيين النماذج بنجاح', 'success');
                    updateAvailableModels();
                    updateTrainerDashboard();
                } catch (error) {
                    showTrainerMessage('❌ خطأ في إعادة تعيين النماذج', 'error');
                }
            }
        }

        async function clearAllDataAdmin() {
            if (confirm('⚠️ تحذير: هل أنت متأكد من مسح جميع البيانات؟')) {
                if (confirm('هذا سيمسح جميع النتائج نهائياً. هل أنت متأكد؟')) {
                    try {
                        await clearAllData();
                        showTrainerMessage('✅ تم مسح جميع البيانات بنجاح', 'success');
                        updateTrainerDashboard();
                        updateAvailableModels();
                    } catch (error) {
                        showTrainerMessage('❌ خطأ في مسح البيانات', 'error');
                    }
                }
            }
        }

        async function exportResults() {
            try {
                const dashboardData = await getTrainerDashboardData();
                const completedExams = dashboardData.completedExams;
                
                if (completedExams.length === 0) {
                    showTrainerMessage('❌ لا توجد نتائج للتصدير', 'error');
                    return;
                }

                let csvContent = 'اسم الطالب,النموذج,الدرجة,إجمالي النقاط,النسبة المئوية,الإجابات الصحيحة,إجمالي الأسئلة,مدة الامتحان,وقت الإكمال\n';
                
                completedExams.forEach(exam => {
                    const duration = `${Math.floor(exam.examDuration / 60)}:${(exam.examDuration % 60).toString().padStart(2, '0')}`;
                    const completedTime = exam.completedAt ? exam.completedAt.toDate().toLocaleString('ar-EG') : 'غير محدد';
                    csvContent += `${exam.studentName},${exam.model},${exam.score},${exam.totalPoints},${exam.percentage}%,${exam.correctAnswers},${exam.totalQuestions},${duration},${completedTime}\n`;
                });

                const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `نتائج_امتحان_${new Date().toISOString().split('T')[0]}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showTrainerMessage('✅ تم تصدير النتائج بنجاح', 'success');
            } catch (error) {
                showTrainerMessage('❌ خطأ في تصدير النتائج', 'error');
            }
        }

        // تحديث البيانات كل 30 ثانية
        setInterval(() => {
            if (isTrainerLoggedIn) {
                updateTrainerDashboard();
            }
        }, 30000);

        // معالجة الأخطاء
        window.addEventListener('error', function(e) {
            console.error('خطأ في النظام:', e.error);
        });

        // مراقبة حالة الاتصال
        window.addEventListener('online', function() {
            if (isFirebaseInitialized) {
                updateConnectionStatus('online');
            }
        });

        window.addEventListener('offline', function() {
            updateConnectionStatus('offline');
        });

        // منع إعادة التحميل أثناء الامتحان
        window.addEventListener('beforeunload', function(e) {
            if (examTimer) {
                e.preventDefault();
                e.returnValue = 'هل أنت متأكد من الخروج؟';
            }
        });

        // تهيئة الصفحة
        showPage('student');
    </script>
</body>
</html>
